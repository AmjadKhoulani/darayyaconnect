import{r as d,j as e,H as M}from"./app-D8KvjWtk.js";import{A as S}from"./AdminLayout-CUoQYiuf.js";import{m as C}from"./maplibre-gl-QQc0gOLL.js";import{A as w}from"./activity-otahktFQ.js";import{c as b}from"./createLucideIcon-BYbfVwB1.js";import{L as F,E as P,W as A}from"./wifi-BH0rYJlW.js";import{D as E,Z as _}from"./zap-DqmVnTXk.js";import{P as O}from"./phone-DWgXfvZr.js";import{M as v}from"./map-Ci9knSyb.js";const R=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],D=b("eye",R);const H=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],W=b("funnel",H);const q=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],I=b("moon",q);const J=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],Z=b("sun",J);function ee({auth:n,users:f}){const m=d.useRef(null),t=d.useRef(null),[i,N]=d.useState(["crowd-electricity","crowd-water"]),[x,$]=d.useState(!1),[h,k]=d.useState("all"),[y,z]=d.useState(!0),u=s=>{const r=i.includes(s),a=r?i.filter(o=>o!==s):[...i,s];if(N(a),t.current){const o=r?"none":"visible";if(t.current.getLayer(`infra-${s}`)&&t.current.setLayoutProperty(`infra-${s}`,"visibility",o),t.current.getLayer(`infra-${s}-nodes-layer`)&&t.current.setLayoutProperty(`infra-${s}-nodes-layer`,"visibility",o),s.startsWith("crowd-")){const c=s.replace("crowd-","");t.current.getLayer(`crowd-${c}-fill`)&&t.current.setLayoutProperty(`crowd-${c}-fill`,"visibility",o),t.current.getLayer(`crowd-${c}-symbol`)&&t.current.setLayoutProperty(`crowd-${c}-symbol`,"visibility",o),t.current.getLayer(`crowd-${c}-circle`)&&t.current.setLayoutProperty(`crowd-${c}-circle`,"visibility",o)}}};return d.useEffect(()=>{if(!t.current||!t.current.getSource("users"))return;const s=h==="all"?null:["==",["get","role"],h];t.current.setFilter("user-heatmap",s),t.current.setFilter("user-point",s)},[h]),d.useEffect(()=>{t.current||m.current&&(t.current=new C.Map({container:m.current,style:{version:8,sources:{osm:{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"&copy; OpenStreetMap Contributors"}},layers:[{id:"osm",type:"raster",source:"osm"}]},center:[36.236,33.456],zoom:13,pitch:0}),t.current.on("load",()=>{if(!t.current)return;const s={type:"FeatureCollection",features:f.map(r=>({type:"Feature",geometry:{type:"Point",coordinates:[Number(r.longitude),Number(r.latitude)]},properties:{id:r.id,intensity:1,role:r.role}}))};t.current.addSource("users",{type:"geojson",data:s}),t.current.addLayer({id:"user-heatmap",type:"heatmap",source:"users",maxzoom:15,paint:{"heatmap-weight":["interpolate",["linear"],["get","intensity"],0,0,6,1],"heatmap-intensity":["interpolate",["linear"],["zoom"],0,1,9,3],"heatmap-color":["interpolate",["linear"],["heatmap-density"],0,"rgba(33,102,172,0)",.2,"rgb(103,169,207)",.4,"rgb(209,229,240)",.6,"rgb(253,219,199)",.8,"rgb(239,138,98)",1,"rgb(178,24,43)"],"heatmap-radius":["interpolate",["linear"],["zoom"],0,2,9,20],"heatmap-opacity":["interpolate",["linear"],["zoom"],7,.8,15,.5]}}),t.current.addLayer({id:"user-point",type:"circle",source:"users",minzoom:13,paint:{"circle-radius":6,"circle-color":["match",["get","role"],"volunteer","#10b981","official","#3b82f6","#d7191c"],"circle-stroke-color":"white","circle-stroke-width":2,"circle-opacity":["interpolate",["linear"],["zoom"],13,.5,15,1]}}),fetch("/api/infrastructure").then(r=>r.json()).then(r=>{t.current&&["water","electricity","sewage","phone"].forEach(a=>{const o=r.lines.filter(l=>l.type===a),c=r.nodes.filter(l=>a==="sewage"&&l.type==="manhole"||a==="electricity"&&(l.type==="transformer"||l.type==="pole")||a==="water"&&l.type==="pump"),L={type:"FeatureCollection",features:o.map(l=>({type:"Feature",geometry:{type:"LineString",coordinates:l.coordinates},properties:{type:l.type}}))};t.current.getSource(`infra-${a}-source`)||t.current.addSource(`infra-${a}-source`,{type:"geojson",data:L});const j={water:"#3b82f6",electricity:"#eab308",sewage:"#78350f",phone:"#10b981"};if(t.current.addLayer({id:`infra-${a}`,type:"line",source:`infra-${a}-source`,layout:{"line-join":"round","line-cap":"round",visibility:"none"},paint:{"line-color":j[a],"line-width":4,"line-opacity":.9}}),c.length>0){const l={type:"FeatureCollection",features:c.map(g=>({type:"Feature",geometry:{type:"Point",coordinates:[parseFloat(g.longitude),parseFloat(g.latitude)]},properties:{type:g.type}}))};t.current.addSource(`infra-${a}-nodes`,{type:"geojson",data:l}),t.current.addLayer({id:`infra-${a}-nodes-layer`,type:"circle",source:`infra-${a}-nodes`,paint:{"circle-radius":6,"circle-color":j[a],"circle-stroke-width":2,"circle-stroke-color":"#fff"},layout:{visibility:"none"}})}})}).catch(r=>console.error("Failed to fetch web infra",r)),["electricity","water"].forEach(r=>{fetch(`/api/infrastructure/status-heatmap?type=${r}`).then(a=>a.json()).then(a=>{t.current&&(t.current.addSource(`crowd-${r}-source`,{type:"geojson",data:a}),t.current.addLayer({id:`crowd-${r}-fill`,type:"fill",source:`crowd-${r}-source`,layout:{visibility:"visible"},paint:{"fill-color":["match",["get","status"],"available","#10b981","unstable","#f59e0b","cutoff","#ef4444","#94a3b8"],"fill-opacity":.4}}),t.current.addLayer({id:`crowd-${r}-circle`,type:"circle",source:`crowd-${r}-source`,layout:{visibility:"visible"},paint:{"circle-radius":14,"circle-color":["match",["get","status"],"available","#10b981","unstable","#f59e0b","cutoff","#ef4444","#94a3b8"],"circle-stroke-width":2,"circle-stroke-color":"#fff"}}),t.current.addLayer({id:`crowd-${r}-symbol`,type:"symbol",source:`crowd-${r}-source`,layout:{visibility:"visible","text-field":"{score}%","text-size":12,"text-font":["Open Sans Bold"]},paint:{"text-color":"#fff","text-halo-color":"#000","text-halo-width":1}}))}).catch(a=>console.error(`Failed to fetch ${r} crowd data`,a))})}))},[]),e.jsxs(S,{user:n.user,header:e.jsxs("h2",{className:"flex items-center gap-2 text-xl font-bold text-slate-800",children:[e.jsx(v,{})," التوزع الجغرافي للمستخدمين"]}),children:[e.jsx(M,{title:"خريطة المستخدمين"}),e.jsxs("div",{className:"relative w-full overflow-hidden rounded-2xl border border-slate-200 shadow-xl",style:{height:"80vh"},children:[e.jsx("div",{ref:m,className:`absolute inset-0 transition-all duration-500 ${x?"contrast-125 hue-rotate-180 invert":""}`,style:{width:"100%",height:"100%"}}),e.jsxs("div",{className:"absolute right-6 top-6 z-10 flex w-72 flex-col gap-4",dir:"rtl",children:[e.jsxs("div",{className:"animate-fade-in-up rounded-2xl border border-white/50 bg-white/90 p-5 shadow-lg backdrop-blur-md",children:[e.jsxs("div",{className:"mb-2 flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"flex items-center gap-2 text-lg font-black text-slate-800",children:[e.jsx(w,{className:"text-emerald-500",size:20}),"الكثافة الحالية"]}),e.jsx("p",{className:"mt-1 text-[11px] font-bold text-slate-500",children:"توزع المستخدمين النشطين"})]}),e.jsx("button",{onClick:()=>$(!x),className:`rounded-xl p-2 transition-all ${x?"bg-slate-800 text-yellow-400":"bg-slate-100 text-slate-400 hover:text-slate-600"}`,title:x?"الوضع النهاري":"الوضع الليلي",children:x?e.jsx(Z,{size:18}):e.jsx(I,{size:18})})]}),e.jsxs("div",{className:"mt-4 flex items-end gap-3",children:[e.jsx("span",{className:"text-4xl font-black leading-none text-slate-900",children:f.length}),e.jsx("span",{className:"mb-1 rounded-lg bg-slate-100 px-2 py-1 text-xs font-bold text-slate-500",children:"مستخدم مسجل"})]})]}),e.jsxs("div",{className:"rounded-2xl border border-white/50 bg-white/90 p-4 shadow-lg backdrop-blur-md",children:[e.jsxs("h4",{className:"mb-3 flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-400",children:[e.jsx(W,{size:14})," تصفية حسب الدور"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:[{id:"all",label:"الكل",color:"slate"},{id:"user",label:"مواطن",color:"red"},{id:"volunteer",label:"متطوع",color:"emerald"},{id:"official",label:"مسؤول",color:"blue"}].map(s=>e.jsx("button",{onClick:()=>k(s.id),className:`rounded-lg border px-3 py-1.5 text-xs font-bold transition-all ${h===s.id?`bg-${s.color}-500 text-white border-${s.color}-600 shadow-md`:"border-slate-200 bg-white text-slate-500 hover:bg-slate-50"}`,children:s.label},s.id))})]})]}),e.jsx("div",{className:"absolute left-6 top-6 z-10 w-64",dir:"rtl",children:e.jsxs("div",{className:"overflow-hidden rounded-2xl border border-white/50 bg-white/90 shadow-lg backdrop-blur-md transition-all duration-300",children:[e.jsxs("button",{onClick:()=>z(!y),className:"flex w-full items-center justify-between bg-slate-50/50 p-4 transition-colors hover:bg-slate-100/50",children:[e.jsxs("h3",{className:"flex items-center gap-2 font-bold text-slate-800",children:[e.jsx(F,{className:"text-indigo-500",size:20}),"طبقات البنية التحتية"]}),y?e.jsx(D,{size:18,className:"text-slate-400"}):e.jsx(P,{size:18,className:"text-slate-400"})]}),e.jsx("div",{className:`scrollbar-thin scrollbar-thumb-slate-200 overflow-y-auto transition-all duration-300 ease-in-out ${y?"max-h-[600px] opacity-100":"max-h-0 opacity-0"}`,children:e.jsxs("div",{className:"space-y-2 p-3",children:[e.jsx(p,{active:i.includes("water"),onClick:()=>u("water"),icon:e.jsx(E,{size:18}),label:"شبكة المياه",color:"blue"}),e.jsx(p,{active:i.includes("electricity"),onClick:()=>u("electricity"),icon:e.jsx(_,{size:18}),label:"الكهرباء",color:"yellow"}),e.jsx(p,{active:i.includes("sewage"),onClick:()=>u("sewage"),icon:e.jsx(A,{size:18,className:"rotate-90"}),label:"الصرف الصحي",color:"orange"}),e.jsx(p,{active:i.includes("phone"),onClick:()=>u("phone"),icon:e.jsx(O,{size:18}),label:"الهاتف",color:"emerald"}),e.jsx("div",{className:"my-2 h-px bg-slate-200"}),e.jsx("p",{className:"mb-1 px-1 text-[10px] font-bold text-slate-400",children:"حالة الشبكة (مجتمعي)"}),e.jsx(p,{active:i.includes("crowd-electricity"),onClick:()=>u("crowd-electricity"),icon:e.jsx(w,{size:18}),label:"كهرباء (بلاغات)",color:"amber"}),e.jsx(p,{active:i.includes("crowd-water"),onClick:()=>u("crowd-water"),icon:e.jsx(w,{size:18}),label:"مياه (بلاغات)",color:"blue"})]})})]})}),f.length===0&&e.jsx("div",{className:"pointer-events-none absolute inset-0 z-0 flex items-center justify-center bg-slate-100/50 backdrop-blur-sm",children:e.jsxs("div",{className:"flex animate-pulse items-center gap-3 rounded-2xl bg-white px-6 py-4 shadow-xl",children:[e.jsx(v,{className:"text-slate-300",size:24}),e.jsx("span",{className:"font-bold text-slate-400",children:"جاري تحميل بيانات الخريطة..."})]})})]})]})}const p=({active:n,onClick:f,icon:m,label:t,color:i})=>e.jsxs("button",{onClick:f,className:`group flex w-full items-center gap-3 rounded-xl border p-3 transition-all duration-200 ${n?`bg-${i}-50 border-${i}-200 shadow-inner`:"border-transparent bg-white hover:bg-slate-50"}`,children:[e.jsx("div",{className:`flex h-8 w-8 items-center justify-center rounded-lg transition-colors ${n?`bg-${i}-500 text-white shadow-md`:"bg-slate-100 text-slate-400 group-hover:text-slate-600"}`,children:m}),e.jsxs("div",{className:"flex-1 text-right",children:[e.jsx("span",{className:`block text-xs font-bold ${n?"text-slate-800":"text-slate-500"}`,children:t}),e.jsx("div",{className:`mt-1.5 h-1 w-full rounded-full transition-all ${n?`bg-${i}-500 opacity-100`:"bg-slate-200 opacity-0"}`})]}),e.jsx("div",{className:`flex h-4 w-4 items-center justify-center rounded-full border-2 transition-all ${n?`border-${i}-500 bg-${i}-500`:"border-slate-300"}`,children:n&&e.jsx("div",{className:"h-1.5 w-1.5 rounded-full bg-white"})})]});export{ee as default};
