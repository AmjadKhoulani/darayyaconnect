import { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowRight, Clock, Eye, Share2, Heart, MessageCircle, Bookmark } from 'lucide-react';
import api from '../services/api';
import { usePullToRefresh, PullToRefreshContainer } from '../hooks/usePullToRefresh';

interface NewsItem {
    id: number;
    title: string;
    content: string;
    summary: string;
    image?: string;
    source: string;
    source_icon: string;
    category: string;
    created_at: string;
    views: number;
    likes: number;
}

export default function News() {
    const [news, setNews] = useState<NewsItem[]>([]);
    const [loading, setLoading] = useState(true);
    const navigate = useNavigate();

    const fetchNews = useCallback(async () => {
        try {
            const res = await api.get('/portal/posts');
            setNews(res.data);
        } catch (err) {
            // Demo data
            setNews([
                {
                    id: 1,
                    title: 'ÿßŸÅÿ™ÿ™ÿßÿ≠ ŸÖÿ±ŸÉÿ≤ ÿµÿ≠Ÿä ÿ¨ÿØŸäÿØ ŸÅŸä ÿ≠Ÿä ÿßŸÑÿ≤ŸáŸàÿ±',
                    content: 'ÿ£ÿπŸÑŸÜÿ™ ÿßŸÑŸÖÿØŸäÿ±Ÿäÿ© ÿßŸÑÿπÿßŸÖÿ© ŸÑŸÑÿµÿ≠ÿ© ÿπŸÜ ÿßŸÅÿ™ÿ™ÿßÿ≠ ŸÖÿ±ŸÉÿ≤ ÿµÿ≠Ÿä ŸÖÿ™ŸÉÿßŸÖŸÑ ŸÅŸä ÿ≠Ÿä ÿßŸÑÿ≤ŸáŸàÿ± ÿ®ŸáÿØŸÅ ÿ™ŸÇÿØŸäŸÖ ÿßŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑÿµÿ≠Ÿäÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ© ŸÑŸÑŸÖŸàÿßÿ∑ŸÜŸäŸÜ. Ÿäÿ∂ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿπŸäÿßÿØÿßÿ™ ŸÖÿ™ŸÜŸàÿπÿ© ÿ™ÿ¥ŸÖŸÑ ÿ∑ÿ® ÿßŸÑÿ£ÿ≥ÿ±ÿ© ŸàÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ ŸàÿßŸÑŸÜÿ≥ÿßÿ¶Ÿäÿ©ÿå ÿ®ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÖÿÆÿ™ÿ®ÿ± ŸàÿµŸäÿØŸÑŸäÿ©.\n\nÿ≥ŸäÿπŸÖŸÑ ÿßŸÑŸÖÿ±ŸÉÿ≤ ŸÖŸÜ ÿßŸÑÿ≥ÿßÿπÿ© 8 ÿµÿ®ÿßÿ≠ÿßŸã ÿ≠ÿ™Ÿâ 8 ŸÖÿ≥ÿßÿ°Ÿã ŸäŸàŸÖŸäÿßŸã ÿπÿØÿß ÿßŸÑÿ¨ŸÖÿπÿ©. ŸàŸäÿ£ÿ™Ÿä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ∂ŸÖŸÜ ÿÆÿ∑ÿ© Ÿàÿ≤ÿßÿ±ÿ© ÿßŸÑÿµÿ≠ÿ© ŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ±ÿπÿßŸäÿ© ÿßŸÑÿµÿ≠Ÿäÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ© ŸÅŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑÿ≥ŸÉŸÜŸäÿ©.',
                    summary: 'ÿßŸÅÿ™ÿ™ÿßÿ≠ ŸÖÿ±ŸÉÿ≤ ÿµÿ≠Ÿä ŸÖÿ™ŸÉÿßŸÖŸÑ ŸäŸÇÿØŸÖ ÿÆÿØŸÖÿßÿ™ ÿ∑ÿ®Ÿäÿ© ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑÿ£ŸáÿßŸÑŸä',
                    source: 'ŸÖÿØŸäÿ±Ÿäÿ© ÿßŸÑÿµÿ≠ÿ©',
                    source_icon: 'üè•',
                    category: 'ÿµÿ≠ÿ©',
                    created_at: new Date().toISOString(),
                    views: 1523,
                    likes: 89
                },
                {
                    id: 2,
                    title: 'ÿ•ÿπŸÑÿßŸÜ ÿπŸÜ ÿ≠ŸÖŸÑÿ© ÿ™ÿ∑ŸàÿπŸäÿ© ŸÑÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ≠ÿØÿßÿ¶ŸÇ ÿßŸÑÿπÿßŸÖÿ©',
                    content: 'ÿ™ŸÜÿ∏ŸÖ ÿ®ŸÑÿØŸäÿ© ÿØÿßÿ±Ÿäÿß ÿ®ÿßŸÑÿ™ÿπÿßŸàŸÜ ŸÖÿπ ÿ¨ŸÖÿπŸäÿ© ÿ£ÿµÿØŸÇÿßÿ° ÿßŸÑÿ®Ÿäÿ¶ÿ© ÿ≠ŸÖŸÑÿ© ÿ™ÿ∑ŸàÿπŸäÿ© Ÿàÿßÿ≥ÿπÿ© ŸÑÿ™ŸÜÿ∏ŸäŸÅ Ÿàÿ™ÿ¨ŸÖŸäŸÑ ÿßŸÑÿ≠ÿØÿßÿ¶ŸÇ ÿßŸÑÿπÿßŸÖÿ© ŸÅŸä ÿßŸÑŸÖÿØŸäŸÜÿ©.\n\nÿ≥ÿ™ŸÜÿ∑ŸÑŸÇ ÿßŸÑÿ≠ŸÖŸÑÿ© ŸäŸàŸÖ ÿßŸÑÿ≥ÿ®ÿ™ ÿßŸÑŸÇÿßÿØŸÖ ŸÖŸÜ ÿßŸÑÿ≥ÿßÿπÿ© 8 ÿµÿ®ÿßÿ≠ÿßŸã Ÿàÿ≠ÿ™Ÿâ ÿßŸÑÿ∏Ÿáÿ±. ŸÜÿØÿπŸà ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ™ÿ∑ŸàÿπŸäŸÜ ŸÑŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿπÿ®ÿ± ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ£Ÿà ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ•ŸÑŸâ ÿ≠ÿØŸäŸÇÿ© ÿßŸÑÿ¥ŸáÿØÿßÿ°.\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ŸàŸÅŸäÿ± ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ ŸàÿßŸÑŸÇŸÅÿßÿ≤ÿßÿ™ÿå ŸàŸäÿ±ÿ¨Ÿâ ÿ•ÿ≠ÿ∂ÿßÿ± ŸÇÿ®ÿπÿ© ŸàŸÖÿßÿ°. ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉŸàŸÜ ÿ≥Ÿäÿ≠ÿµŸÑŸàŸÜ ÿπŸÑŸâ ÿ¥ŸáÿßÿØÿßÿ™ ÿ™ŸÇÿØŸäÿ±Ÿäÿ©.',
                    summary: 'ÿ≠ŸÖŸÑÿ© ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ≠ÿØÿßÿ¶ŸÇ ŸäŸàŸÖ ÿßŸÑÿ≥ÿ®ÿ™ - ÿ≥ÿ¨ŸÑ ŸÖÿ¥ÿßÿ±ŸÉÿ™ŸÉ',
                    source: 'ÿßŸÑÿ®ŸÑÿØŸäÿ©',
                    source_icon: 'üèõÔ∏è',
                    category: 'ŸÖÿ¨ÿ™ŸÖÿπ',
                    created_at: new Date(Date.now() - 86400000).toISOString(),
                    views: 845,
                    likes: 156
                },
                {
                    id: 3,
                    title: 'ÿ™ŸÖÿØŸäÿØ ÿ≥ÿßÿπÿßÿ™ ÿ™ÿ∫ÿ∞Ÿäÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ° ÿÆŸÑÿßŸÑ ŸÅÿµŸÑ ÿßŸÑÿ¥ÿ™ÿßÿ°',
                    content: 'ÿ£ÿπŸÑŸÜÿ™ ÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ° ÿπŸÜ ÿ≤ŸäÿßÿØÿ© ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ© ÿÆŸÑÿßŸÑ ŸÅÿµŸÑ ÿßŸÑÿ¥ÿ™ÿßÿ° ŸÑÿ™ÿµŸÑ ÿ•ŸÑŸâ 8 ÿ≥ÿßÿπÿßÿ™ ŸäŸàŸÖŸäÿßŸã ÿ®ÿØŸÑÿßŸã ŸÖŸÜ 6 ÿ≥ÿßÿπÿßÿ™.\n\nÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿßŸÑÿ¨ÿØŸäÿØ:\n- ŸÖŸÜ 6 ÿµÿ®ÿßÿ≠ÿßŸã ÿ•ŸÑŸâ 10 ÿµÿ®ÿßÿ≠ÿßŸã\n- ŸÖŸÜ 4 ÿπÿµÿ±ÿßŸã ÿ•ŸÑŸâ 8 ŸÖÿ≥ÿßÿ°Ÿã\n\nŸäÿ±ÿ¨Ÿâ ŸÖŸÜ ÿßŸÑŸÖŸàÿßÿ∑ŸÜŸäŸÜ ÿ™ÿ±ÿ¥ŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ŸÑÿ∂ŸÖÿßŸÜ ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿßŸÑÿÆÿØŸÖÿ©.',
                    summary: 'ÿ≤ŸäÿßÿØÿ© ÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ° ÿ•ŸÑŸâ 8 ÿ≥ÿßÿπÿßÿ™ ŸäŸàŸÖŸäÿßŸã',
                    source: 'ÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ°',
                    source_icon: '‚ö°',
                    category: 'ÿÆÿØŸÖÿßÿ™',
                    created_at: new Date(Date.now() - 172800000).toISOString(),
                    views: 2341,
                    likes: 234
                }
            ]);
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        fetchNews();
    }, [fetchNews]);

    const { isRefreshing, pullMoveY, handlers } = usePullToRefresh(fetchNews);

    const getCategoryColor = (cat: string) => {
        const colors: Record<string, string> = {
            'ÿµÿ≠ÿ©': 'emerald',
            'ŸÖÿ¨ÿ™ŸÖÿπ': 'blue',
            'ÿÆÿØŸÖÿßÿ™': 'amber',
            'ÿ£ÿÆÿ®ÿßÿ±': 'slate'
        };
        return colors[cat] || 'slate';
    };

    const formatDate = (date: string) => {
        const d = new Date(date);
        const now = new Date();
        const diffMs = now.getTime() - d.getTime();
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

        if (diffHours < 1) return 'ŸÖŸÜÿ∞ ÿØŸÇÿßÿ¶ŸÇ';
        if (diffHours < 24) return `ŸÖŸÜÿ∞ ${diffHours} ÿ≥ÿßÿπÿ©`;
        if (diffHours < 48) return 'ÿ£ŸÖÿ≥';
        return d.toLocaleDateString('ar-SY');
    };

    // News Detail View
    if (selectedNews) {
        const color = getCategoryColor(selectedNews.category);
        return (
            <div className="min-h-screen bg-white pb-20" dir="rtl">
                {/* Header */}
                <header className="bg-white border-b border-slate-200 sticky top-0 z-40 px-4 py-4 shadow-sm">
                    <div className="flex items-center gap-3">
                        <button
                            onClick={() => setSelectedNews(null)}
                            className="w-10 h-10 bg-slate-50 hover:bg-slate-100 rounded-xl flex items-center justify-center text-slate-600 transition-colors border border-slate-200"
                        >
                            <ArrowRight size={20} className="rotate-180" />
                        </button>
                        <div className="flex-1">
                            <h1 className="text-sm font-bold text-slate-800 line-clamp-1">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿ®ÿ±</h1>
                        </div>
                        <button className="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-500 border border-slate-200">
                            <Share2 size={18} />
                        </button>
                        <button className="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-500 border border-slate-200">
                            <Bookmark size={18} />
                        </button>
                    </div>
                </header>

                <main className="px-4 py-6 space-y-6">
                    {/* Category & Date */}
                    <div className="flex items-center justify-between">
                        <span className={`bg-${color}-50 text-${color}-600 text-xs font-bold px-3 py-1.5 rounded-lg border border-${color}-100`}>
                            {selectedNews.category}
                        </span>
                        <div className="flex items-center gap-2 text-xs text-slate-500">
                            <Clock size={14} />
                            {formatDate(selectedNews.created_at)}
                        </div>
                    </div>

                    {/* Title */}
                    <h1 className="text-xl font-black text-slate-900 leading-relaxed">
                        {selectedNews.title}
                    </h1>

                    {/* Source */}
                    <div className="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-xl border border-slate-200">
                            {selectedNews.source_icon}
                        </div>
                        <div>
                            <p className="text-xs font-bold text-slate-800">{selectedNews.source}</p>
                            <p className="text-[10px] text-slate-500">ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä</p>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="prose prose-slate prose-sm max-w-none">
                        <p className="text-slate-700 leading-relaxed whitespace-pre-line text-sm">
                            {selectedNews.content}
                        </p>
                    </div>

                    {/* Stats */}
                    <div className="flex items-center gap-4 py-4 border-t border-b border-slate-100">
                        <div className="flex items-center gap-2 text-slate-500">
                            <Eye size={16} />
                            <span className="text-xs font-medium">{selectedNews.views} ŸÖÿ¥ÿßŸáÿØÿ©</span>
                        </div>
                        <div className="flex items-center gap-2 text-rose-500">
                            <Heart size={16} />
                            <span className="text-xs font-medium">{selectedNews.likes} ÿ•ÿπÿ¨ÿßÿ®</span>
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="flex gap-3">
                        <button className="flex-1 bg-rose-50 text-rose-600 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 border border-rose-100">
                            <Heart size={18} />
                            ÿ•ÿπÿ¨ÿßÿ®
                        </button>
                        <button className="flex-1 bg-blue-50 text-blue-600 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 border border-blue-100">
                            <Share2 size={18} />
                            ŸÖÿ¥ÿßÿ±ŸÉÿ©
                        </button>
                    </div>
                </main>
            </div>
        );
    }

    // News List View
    return (
        <div className="min-h-screen bg-slate-50 pb-20" dir="rtl" {...handlers}>
            <PullToRefreshContainer isRefreshing={isRefreshing} pullMoveY={pullMoveY}>
                {/* Header */}
                <header className="bg-white border-b border-slate-200 sticky top-0 z-40 px-4 py-4 shadow-sm">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <button
                                onClick={() => navigate(-1)}
                                className="w-10 h-10 bg-slate-50 hover:bg-slate-100 rounded-xl flex items-center justify-center text-slate-600 transition-colors border border-slate-200"
                            >
                                <ArrowRight size={20} className="rotate-180" />
                            </button>
                            <div>
                                <h1 className="text-lg font-bold text-slate-800">ÿßŸÑÿ£ÿÆÿ®ÿßÿ±</h1>
                                <p className="text-[11px] text-slate-500 font-medium">ÿ¢ÿÆÿ± ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑŸÖÿØŸäŸÜÿ©</p>
                            </div>
                        </div>
                    </div>
                </header>

                <main className="px-4 py-6 space-y-4">
                    {loading ? (
                        <div className="space-y-4">
                            {[1, 2, 3].map(i => (
                                <div key={i} className="bg-white rounded-2xl p-5 animate-pulse border border-slate-100">
                                    <div className="h-4 bg-slate-200 rounded w-3/4 mb-3"></div>
                                    <div className="h-3 bg-slate-100 rounded w-full mb-2"></div>
                                    <div className="h-3 bg-slate-100 rounded w-2/3"></div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        news.map((item, index) => {
                            const color = getCategoryColor(item.category);
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => setSelectedNews(item)}
                                    className={`w-full bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:border-emerald-200 transition-all text-right group animate-fade-in-up`}
                                    style={{ animationDelay: `${index * 100}ms` }}
                                >
                                    <div className="flex items-start gap-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className={`bg-${color}-50 text-${color}-600 text-[10px] font-bold px-2 py-1 rounded-lg border border-${color}-100`}>
                                                    {item.category}
                                                </span>
                                                <span className="text-[10px] text-slate-400 font-medium">{formatDate(item.created_at)}</span>
                                            </div>
                                            <h3 className="font-bold text-slate-900 text-sm mb-2 leading-relaxed line-clamp-2 group-hover:text-emerald-700 transition-colors">
                                                {item.title}
                                            </h3>
                                            <p className="text-xs text-slate-500 line-clamp-2 mb-3 leading-relaxed opacity-80">
                                                {item.summary}
                                            </p>
                                            <div className="flex items-center justify-between pt-2 border-t border-slate-50">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-lg filter grayscale group-hover:grayscale-0 transition-all">{item.source_icon}</span>
                                                    <span className="text-[10px] text-slate-500 font-bold">{item.source}</span>
                                                </div>
                                                <div className="flex items-center gap-3 text-[10px] text-slate-400 font-medium">
                                                    <span className="flex items-center gap-1 bg-slate-50 px-2 py-0.5 rounded-full">
                                                        <Eye size={12} /> {item.views}
                                                    </span>
                                                    <span className="flex items-center gap-1 bg-rose-50 text-rose-500 px-2 py-0.5 rounded-full">
                                                        <Heart size={12} className="fill-rose-500" /> {item.likes}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </button>
                            );
                        })
                    )}
                </main>
            </PullToRefreshContainer>
        </div>
    );
}
